name: Update README with Languages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: pip install PyGithub
      
    - name: Generate languages data
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python3 << "EOF"
        import os
        import re
        from github import Github
        from datetime import datetime
        
        token = os.environ.get("GH_TOKEN")
        username = "MarcoTuliops22"
        
        if not token:
            print("Error: No GitHub token")
            exit(1)
        
        try:
            g = Github(token)
            user = g.get_user(username)
            
            print("Collecting repository data...")
            
            languages = {}
            repos_info = []
            
            for repo in user.get_repos():
                if repo.private:
                    continue
                
                repo_langs = repo.get_languages()
                for lang in repo_langs:
                    languages[lang] = languages.get(lang, 0) + 1
                
                if repo_langs:
                    repos_info.append({
                        "name": repo.name,
                        "url": repo.html_url,
                        "stars": repo.stargazers_count,
                        "updated": repo.updated_at.strftime("%b %Y") if repo.updated_at else "N/A",
                        "langs": list(repo_langs.keys())[:3]
                    })
            
            # Sort languages by count
            sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)
            
            # Language emojis
            emoji_map = {
                "HTML": "üåê", "CSS": "üé®", "JavaScript": "üìú",
                "Python": "üêç", "Java": "‚òï", "Shell": "üêö",
                "TypeScript": "üìò", "PHP": "üêò", "Ruby": "üíé"
            }
            
            now = datetime.now().strftime("%d/%m/%Y %H:%M")
            
            # Create new section
            new_section = f"""<!-- START_AUTO_LANGUAGES -->
## üìä Relat√≥rio de Linguagens

**üìÖ Atualizado em:** {now}
**üìÅ Reposit√≥rios p√∫blicos:** {len(repos_info)}
**üåê Linguagens √∫nicas:** {len(languages)}

**üèÜ Top Linguagens:**
"""
            
            # Add top languages
            for lang, count in sorted_langs[:8]:
                emoji = emoji_map.get(lang, "üíª")
                new_section += f"- {emoji} **{lang}:** {count} reposit√≥rios\n"
            
            new_section += f"""
**üìã Reposit√≥rios Principais:**
"""
            
            # Add top repositories
            repos_info.sort(key=lambda x: x["stars"], reverse=True)
            for repo in repos_info[:8]:
                langs_str = ", ".join(repo["langs"])
                if len(repo["langs"]) > 3:
                    langs_str += "..."
                new_section += f"- [{repo['name']}]({repo['url']}) - {langs_str} (‚≠ê{repo['stars']})\n"
            
            new_section += f"""
*Atualiza√ß√£o autom√°tica via GitHub Actions*
<!-- END_AUTO_LANGUAGES -->"""
            
            # Read current README
            with open("README.md", "r", encoding="utf-8") as f:
                content = f.read()
            
            # Check if section exists
            pattern = r"<!-- START_AUTO_LANGUAGES -->.*<!-- END_AUTO_LANGUAGES -->"
            
            if re.search(pattern, content, re.DOTALL):
                # Update existing section
                content = re.sub(pattern, new_section, content, flags=re.DOTALL)
                print("Updated existing languages section")
            else:
                # Insert after Technologies section
                insert_point = "## üîß Technologies & Tools"
                if insert_point in content:
                    # Add after the section
                    lines = content.split("\n")
                    new_content = []
                    inserted = False
                    
                    for line in lines:
                        new_content.append(line)
                        if line.strip() == insert_point and not inserted:
                            # Find end of this section
                            new_content.append("")
                            new_content.append(new_section)
                            inserted = True
                    
                    if inserted:
                        content = "\n".join(new_content)
                        print("Inserted languages section after Technologies & Tools")
                    else:
                        content += "\n\n" + new_section
                        print("Added languages section at the end")
                else:
                    # Add at the end
                    content += "\n\n" + new_section
                    print("Added languages section at the end")
            
            # Write updated README
            with open("README.md", "w", encoding="utf-8") as f:
                f.write(content)
            
            print(f"‚úÖ README atualizado com sucesso!")
            print(f"üìä Total de reposit√≥rios: {len(repos_info)}")
            print(f"üåê Linguagens encontradas: {len(languages)}")
            
            # Show top 3 languages
            if sorted_langs:
                print(f"üèÜ Top 3: {', '.join([lang for lang, _ in sorted_langs[:3]])}")
            
        except Exception as e:
            print(f"‚ùå Erro: {str(e)}")
            import traceback
            traceback.print_exc()
            exit(1)
        EOF
    
    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        git diff --cached --quiet || git commit -m "üìä Atualizar relat√≥rio de linguagens no README"
        git push