name: Update README with Languages Report

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: pip install PyGithub
        
      - name: Generate languages data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          from github import Github
          from collections import defaultdict
          from datetime import datetime
          
          token = os.getenv('GITHUB_TOKEN')
          username = 'MarcoTuliops22'
          
          if not token:
              print('Error: No GitHub token')
              exit(1)
          
          try:
              g = Github(token)
              user = g.get_user(username)
              
              print(f'Getting repositories for {username}...')
              
              languages = defaultdict(int)
              repo_count = 0
              star_count = 0
              
              for repo in user.get_repos():
                  repo_count += 1
                  star_count += repo.stargazers_count
                  
                  repo_langs = repo.get_languages()
                  for lang in repo_langs:
                      languages[lang] += 1
                  
                  if repo_count % 10 == 0:
                      print(f'  Processed {repo_count} repos...')
              
              print(f'\nTotal repositories: {repo_count}')
              print(f'Total stars: {star_count}')
              print(f'Unique languages: {len(languages)}')
              
              sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)
              
              with open('languages_data.txt', 'w') as f:
                  f.write(f'Username: {username}\n')
                  f.write(f'Date: {datetime.now().strftime("%Y-%m-%d %H:%M")}\n')
                  f.write(f'Total repos: {repo_count}\n')
                  f.write(f'Total stars: {star_count}\n')
                  f.write(f'Unique languages: {len(languages)}\n\n')
                  f.write('Languages found:\n')
                  for lang, count in sorted_langs:
                      f.write(f'  - {lang}: {count} repos\n')
              
              print('Data saved to languages_data.txt')
              
          except Exception as e:
              print(f'Error: {str(e)}')
              exit(1)
          EOF
          
      - name: Update README with languages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << 'EOF'
          import os
          from github import Github
          from collections import defaultdict
          from datetime import datetime
          import re
          
          token = os.getenv('GITHUB_TOKEN')
          username = 'MarcoTuliops22'
          
          if not token:
              print('Error: No GitHub token')
              exit(1)
          
          try:
              g = Github(token)
              user = g.get_user(username)
              
              languages = defaultdict(int)
              repo_list = []
              
              for repo in user.get_repos():
                  if repo.private:
                      continue
                      
                  repo_langs = repo.get_languages()
                  for lang in repo_langs:
                      languages[lang] += 1
                  
                  if repo_langs:
                      repo_list.append({
                          'name': repo.name,
                          'url': repo.html_url,
                          'stars': repo.stargazers_count,
                          'updated': repo.updated_at.strftime('%b %Y') if repo.updated_at else 'N/A',
                          'langs': list(repo_langs.keys())
                      })
              
              sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)
              
              emoji_map = {
                  'HTML': 'üåê', 'CSS': 'üé®', 'JavaScript': 'üìú',
                  'Python': 'üêç', 'Java': '‚òï', 'C++': '‚öôÔ∏è',
                  'Shell': 'üêö', 'Dockerfile': 'üê≥', 'PHP': 'üêò',
                  'TypeScript': 'üìò', 'Ruby': 'üíé', 'Go': 'üêπ'
              }
              
              now = datetime.now().strftime('%d/%m/%Y %H:%M')
              
              new_section = f"""<!-- START_LANGUAGES_SECTION -->
## üìä Relat√≥rio de Linguagens

**üìà Estat√≠sticas:**
- **Total de reposit√≥rios:** {len(repo_list)}
- **Total de linguagens:** {len(languages)}
- **√öltima atualiza√ß√£o:** {now}

**üèÜ Top Linguagens:**
"""
              
              for lang, count in sorted_langs[:8]:
                  emoji = emoji_map.get(lang, 'üíª')
                  new_section += f"- {emoji} **{lang}:** {count} reposit√≥rios\n"
              
              new_section += f"""
**üìã Todos os Reposit√≥rios:**
| Reposit√≥rio | Linguagens | Estrelas | Atualiza√ß√£o |
|-------------|------------|----------|-------------|
"""
              
              for repo in sorted(repo_list, key=lambda x: x['stars'], reverse=True)[:15]:
                  langs = ', '.join(repo['langs'][:3])
                  if len(repo['langs']) > 3:
                      langs += f' (+{len(repo["langs"])-3})'
                  new_section += f"| [{repo['name']}]({repo['url']}) | {langs} | ‚≠ê{repo['stars']} | {repo['updated']} |\n"
              
              new_section += f"""
*Relat√≥rio gerado automaticamente*
<!-- END_LANGUAGES_SECTION -->"""
              
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              pattern = r'<!-- START_LANGUAGES_SECTION -->.*<!-- END_LANGUAGES_SECTION -->'
              
              if re.search(pattern, content, re.DOTALL):
                  content = re.sub(pattern, new_section, content, flags=re.DOTALL)
                  print('Updated existing section')
              else:
                  marker = '## üîß Technologies & Tools'
                  if marker in content:
                      content = content.replace(marker, marker + '\n\n' + new_section)
                      print('Added section after Technologies & Tools')
                  else:
                      content += '\n\n' + new_section
                      print('Added section at the end')
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(content)
              
              print('README updated successfully!')
              
          except Exception as e:
              print(f'Error updating README: {str(e)}')
              exit(1)
          EOF
          
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md languages_data.txt
          git commit -m "üìä Update languages report in README" || echo "No changes to commit"
          git push
