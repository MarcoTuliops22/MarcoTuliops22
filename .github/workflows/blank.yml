name: Update README with Languages

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install PyGithub
        run: pip install PyGithub
        
      - name: Generate languages section
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 << "EOF"
          import os
          import re
          from github import Github
          from collections import defaultdict
          from datetime import datetime
          
          token = os.environ.get("GH_TOKEN")
          username = "MarcoTuliops22"
          
          if not token:
              print("Error: No GitHub token")
              exit(1)
          
          try:
              g = Github(token)
              user = g.get_user(username)
              
              print(f"Analyzing repositories for: {username}")
              
              languages = defaultdict(int)
              repos = []
              total_stars = 0
              
              for repo in user.get_repos():
                  if repo.private:
                      continue
                      
                  repo_langs = repo.get_languages()
                  for lang in repo_langs:
                      languages[lang] += 1
                  
                  repos.append({
                      "name": repo.name,
                      "url": repo.html_url,
                      "stars": repo.stargazers_count,
                      "updated": repo.updated_at.strftime("%b %Y") if repo.updated_at else "N/A",
                      "langs": list(repo_langs.keys())
                  })
                  
                  total_stars += repo.stargazers_count
              
              sorted_langs = sorted(languages.items(), key=lambda x: x[1], reverse=True)
              
              emoji_map = {
                  "HTML": "üåê", "CSS": "üé®", "JavaScript": "üìú",
                  "Python": "üêç", "Java": "‚òï", "C++": "‚öôÔ∏è",
                  "Shell": "üêö", "TypeScript": "üìò", "PHP": "üêò"
              }
              
              now = datetime.now().strftime("%d/%m/%Y %H:%M")
              
              new_section = f"""<!-- START_LANGUAGES -->
## üìä Relat√≥rio de Linguagens

**üìà Estat√≠sticas Atualizadas:**
- **Reposit√≥rios p√∫blicos:** {len(repos)}
- **Total de estrelas:** {total_stars} ‚≠ê
- **Linguagens diferentes:** {len(languages)}
- **√öltima an√°lise:** {now}

**üèÜ Top Linguagens:**
"""
              
              for lang, count in sorted_langs[:10]:
                  emoji = emoji_map.get(lang, "üíª")
                  percentage = (count / len(repos)) * 100 if repos else 0
                  new_section += f"- {emoji} **{lang}:** {count} repos ({percentage:.1f}%)\n"
              
              new_section += f"""
**üìã Reposit√≥rios Recentes:**
| Reposit√≥rio | Linguagens | Estrelas | Atualizado |
|-------------|------------|----------|------------|
"""
              
              sorted_repos = sorted(repos, key=lambda x: x["stars"], reverse=True)[:10]
              
              for repo in sorted_repos:
                  langs = ", ".join(repo["langs"][:2])
                  if len(repo["langs"]) > 2:
                      langs += f" (+{len(repo['langs'])-2})"
                  new_section += f"| [{repo['name']}]({repo['url']}) | {langs} | ‚≠ê{repo['stars']} | {repo['updated']} |\n"
              
              new_section += f"""
*Relat√≥rio gerado automaticamente pelo GitHub Actions*
<!-- END_LANGUAGES -->"""
              
              with open("README.md", "r", encoding="utf-8") as f:
                  content = f.read()
              
              pattern = r"<!-- START_LANGUAGES -->.*<!-- END_LANGUAGES -->"
              
              if re.search(pattern, content, re.DOTALL):
                  content = re.sub(pattern, new_section, content, flags=re.DOTALL)
                  print("Updated existing section")
              else:
                  insert_point = "## üîß Technologies & Tools"
                  if insert_point in content:
                      content = content.replace(insert_point, insert_point + "\n\n" + new_section)
                      print("Added section after Technologies & Tools")
                  else:
                      content += "\n\n" + new_section
                      print("Added section at the end")
              
              with open("README.md", "w", encoding="utf-8") as f:
                  f.write(content)
              
              print(f"‚úÖ Success! Analyzed {len(repos)} repositories")
              print(f"üìä Found {len(languages)} unique languages")
              print(f"‚≠ê Total stars: {total_stars}")
              
          except Exception as e:
              print(f"‚ùå Error: {str(e)}")
              exit(1)
          EOF
          
      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "üìä Update languages report"
            git push
          fi
