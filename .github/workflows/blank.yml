name: ðŸ“Š Update GitHub Languages Card

on:
  schedule:
    - cron: '0 8 * * *' # diÃ¡rio Ã s 8h UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyGithub matplotlib pandas

      - name: Generate Languages Card
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python << 'EOF'
          import os
          import matplotlib.pyplot as plt
          from github import Github
          from collections import defaultdict
          from datetime import datetime

          # Conectar ao GitHub usando auth
          token = os.environ.get("GITHUB_TOKEN")
          username = os.environ.get("GITHUB_USERNAME")
          if not token or not username:
              raise Exception("GITHUB_TOKEN ou GITHUB_USERNAME nÃ£o configurados")
          
          g = Github(auth=token)
          user = g.get_user(username)

          # FunÃ§Ã£o segura para datetime
          def parse_iso(iso_str):
              # Corrige offset tipo +00:0 -> +00:00
              if len(iso_str) >= 6 and iso_str[-3] == ":" and len(iso_str[-2:]) == 2 and iso_str[-1] != "0":
                  iso_str = iso_str[:-1] + "0"
              return datetime.fromisoformat(iso_str)

          language_bytes = defaultdict(int)

          print(f"Analisando repositÃ³rios de {username}...")
          for repo in user.get_repos():
              try:
                  langs = repo.get_languages()
                  for lang, b in langs.items():
                      language_bytes[lang] += b
              except Exception as e:
                  print(f"Erro no repo {repo.name}: {e}")
                  continue

          if not language_bytes:
              print("Nenhuma linguagem encontrada")
              exit(0)

          # Ordenar linguagens por bytes
          sorted_langs = sorted(language_bytes.items(), key=lambda x: x[1], reverse=True)
          labels = [l[0] for l in sorted_langs[:10]]  # Top 10
          sizes = [l[1] for l in sorted_langs[:10]]

          # Gerar grÃ¡fico tipo pie
          plt.figure(figsize=(6,6))
          plt.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=140, colors=plt.cm.tab20.colors)
          plt.title(f"Linguagens mais usadas - {username}", fontsize=14)
          plt.tight_layout()

          plt.savefig("github-languages-card.svg", format="svg")
          print("Card gerado em github-languages-card.svg")
          EOF

      - name: Commit and push card
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add github-languages-card.svg
          git diff --cached --quiet || git commit -m "ðŸ“Š Update languages card [skip ci]"
          git push
