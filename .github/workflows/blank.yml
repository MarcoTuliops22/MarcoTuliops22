name: Generate Languages Report

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'  # todo dia Ã s 8h UTC

permissions:
  contents: write

jobs:
  gerar-idiomas:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install PyGithub
        run: pip install PyGithub

      - name: Generate LANGUAGES_REPORT.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python - <<PYTHON_CODE
import os
import sys
from github import Github
from collections import defaultdict
from datetime import datetime

token = os.environ.get("GH_TOKEN")
username = os.environ.get("GITHUB_USERNAME")

if not token or not username:
    print("Erro: GH_TOKEN ou GITHUB_USERNAME nÃ£o configurado")
    sys.exit(1)

g = Github(token)
user = g.get_user(username)

repos_data = []
language_stats = defaultdict(int)
language_bytes = defaultdict(int)

for repo in user.get_repos():
    try:
        langs = repo.get_languages()
        repos_data.append({
            "name": repo.name,
            "url": repo.html_url,
            "languages": langs,
            "primary_language": repo.language or "NÃ£o detectada",
            "stars": repo.stargazers_count,
            "updated_at": repo.updated_at.isoformat() if repo.updated_at else ""
        })
        for lang, b in langs.items():
            language_stats[lang] += 1
            language_bytes[lang] += b
    except Exception as e:
        print(f"Erro ao processar {repo.name}: {e}")

# Markdown seguro com """ para multilinhas
md = f"""# ðŸ“Š RelatÃ³rio de Linguagens - {username}

**Data:** {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')} UTC
**Total de repositÃ³rios analisados:** {len(repos_data)}
**Linguagens Ãºnicas encontradas:** {len(language_stats)}

---

## ðŸ† Top Linguagens por repositÃ³rios
"""
sorted_langs = sorted(language_stats.items(), key=lambda x: x[1], reverse=True)
for lang, count in sorted_langs:
    md += f"- **{lang}**: {count} repositÃ³rios\n"

md += "\n---\n## ðŸ“‹ Lista de RepositÃ³rios\n\n"
md += "| RepositÃ³rio | Linguagem Principal | Outras Linguagens | Estrelas | AtualizaÃ§Ã£o |\n"
md += "|------------|-------------------|-----------------|---------|------------|\n"

for repo in repos_data:
    langs_list = list(repo["languages"].keys())
    other_langs = ", ".join(langs_list[:3])
    if len(langs_list) > 3:
        other_langs += f" (+{len(langs_list)-3})"
    updated = repo["updated_at"][:10] if repo["updated_at"] else "N/A"
    md += f"| [{repo['name']}]({repo['url']}) | {repo['primary_language']} | {other_langs} | {repo['stars']} | {updated} |\n"

with open("LANGUAGES_REPORT.md", "w", encoding="utf-8") as f:
    f.write(md)

print("âœ… LANGUAGES_REPORT.md gerado com sucesso!")
PYTHON_CODE

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add LANGUAGES_REPORT.md
          git diff --cached --quiet || git commit -m "ðŸ“Š AtualizaÃ§Ã£o automÃ¡tica do LANGUAGES_REPORT"
          git push
