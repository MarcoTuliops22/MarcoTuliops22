name: Generate Languages Report

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

permissions:
  contents: write

jobs:
  gerar-idiomas:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install PyGithub
        run: pip install PyGithub

      - name: Generate LANGUAGES_REPORT.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python << 'EOF'
          import os
          import sys
          from github import Github
          from collections import defaultdict
          from datetime import datetime

          token = os.environ.get("GH_TOKEN")
          username = os.environ.get("GITHUB_USERNAME")

          if not token or not username:
              print("Erro: GH_TOKEN ou GITHUB_USERNAME n√£o configurado")
              sys.exit(1)

          try:
              g = Github(token)
              user = g.get_user(username)
              
              repos_data = []
              language_stats = defaultdict(int)
              language_bytes = defaultdict(int)
              
              print(f"Analisando reposit√≥rios de: {username}")
              print("=" * 50)
              
              for repo in user.get_repos():
                  try:
                      print(f"Processando: {repo.name}")
                      langs = repo.get_languages()
                      
                      repo_info = {
                          "name": repo.name,
                          "url": repo.html_url,
                          "languages": langs,
                          "primary_language": repo.language or "N√£o detectada",
                          "stars": repo.stargazers_count,
                          "updated_at": repo.updated_at.isoformat()[:10] if repo.updated_at else "N/A",
                          "is_private": repo.private
                      }
                      
                      repos_data.append(repo_info)
                      
                      for lang, b in langs.items():
                          language_stats[lang] += 1
                          language_bytes[lang] += b
                          
                  except Exception as e:
                      print(f"Erro ao processar {repo.name}: {e}")
                      continue
              
              # Gerar relat√≥rio
              now = datetime.utcnow()
              
              md = "# üìä Relat√≥rio de Linguagens\n\n"
              md += f"**Usu√°rio:** {username}\n"
              md += f"**Data:** {now.strftime('%d/%m/%Y %H:%M')} UTC\n"
              md += f"**Total de reposit√≥rios:** {len(repos_data)}\n"
              md += f"**Linguagens encontradas:** {len(language_stats)}\n\n"
              
              md += "---\n\n"
              md += "## üèÜ Top Linguagens\n\n"
              
              # Top linguagens por reposit√≥rios
              sorted_by_repos = sorted(language_stats.items(), key=lambda x: x[1], reverse=True)
              
              for lang, count in sorted_by_repos[:15]:
                  percentage = (count / len(repos_data) * 100) if repos_data else 0
                  md += f"- **{lang}**: {count} reposit√≥rios ({percentage:.1f}%)\n"
              
              md += "\n---\n\n"
              md += "## üìã Todos os Reposit√≥rios\n\n"
              md += "| Reposit√≥rio | Linguagem Principal | Outras Linguagens | ‚≠ê | Atualiza√ß√£o |\n"
              md += "|------------|-------------------|-----------------|---|------------|\n"
              
              # Ordenar por estrelas
              repos_data.sort(key=lambda x: x['stars'], reverse=True)
              
              for repo in repos_data:
                  langs_list = list(repo["languages"].keys())
                  other_langs = ", ".join(langs_list[:3])
                  if len(langs_list) > 3:
                      other_langs += f" (+{len(langs_list)-3})"
                  
                  private_icon = "üîí" if repo['is_private'] else ""
                  
                  md += f"| {private_icon}[{repo['name']}]({repo['url']}) | {repo['primary_language']} | {other_langs} | {repo['stars']} | {repo['updated_at']} |\n"
              
              # Salvar arquivo
              with open("LANGUAGES_REPORT.md", "w", encoding="utf-8") as f:
                  f.write(md)
              
              print(f"‚úÖ Relat√≥rio gerado com sucesso!")
              print(f"üìä Linguagens encontradas: {len(language_stats)}")
              print(f"üìÅ Reposit√≥rios analisados: {len(repos_data)}")
              
          except Exception as e:
              print(f"‚ùå Erro cr√≠tico: {e}")
              sys.exit(1)
          EOF

      - name: Commit and push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add LANGUAGES_REPORT.md
          if git diff --cached --quiet; then
            echo "Nenhuma mudan√ßa para commitar"
          else
            git commit -m "üìä Atualiza√ß√£o autom√°tica do LANGUAGES_REPORT"
            git push
          fi
