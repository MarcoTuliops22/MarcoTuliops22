name: Generate Languages Card

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  generate-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install --upgrade pip PyGithub matplotlib

      - name: Generate SVG Languages Card
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python <<EOF
import os
from github import Github
from github.Auth import Token
import matplotlib.pyplot as plt
from collections import defaultdict

token = os.environ.get("GH_TOKEN")
username = os.environ.get("GITHUB_USERNAME")
if not token or not username:
    raise Exception("GH_TOKEN ou GITHUB_USERNAME nÃ£o configurados")

g = Github(auth=Token(token))
user = g.get_user(username)

language_bytes = defaultdict(int)
for repo in user.get_repos():
    try:
        langs = repo.get_languages()
        for lang, b in langs.items():
            language_bytes[lang] += b
    except:
        continue

if not language_bytes:
    raise Exception("Nenhuma linguagem encontrada!")

language_bytes = dict(sorted(language_bytes.items(), key=lambda x: x[1], reverse=True))

fig, ax = plt.subplots(figsize=(6,6))
langs = list(language_bytes.keys())
sizes = list(language_bytes.values())
colors = plt.get_cmap('tab20').colors
ax.pie(sizes, labels=langs, autopct='%1.1f%%', startangle=140, colors=colors[:len(langs)])
ax.set_title(f"Linguagens de {username}", fontsize=16)
plt.tight_layout()

fig.savefig("LANGUAGES_CARD.svg", format="svg")
print("âœ… SVG gerado: LANGUAGES_CARD.svg")
EOF

      - name: Commit and push card
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add LANGUAGES_CARD.svg
          if git diff --cached --quiet; then
            echo "âœ… Nenhuma mudanÃ§a para commitar"
          else
            git commit -m "ðŸŽ¨ Update languages card [$(date +'%Y-%m-%d %H:%M')]"
            git push
            echo "âœ… Card atualizado e enviado"
