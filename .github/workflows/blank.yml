name: Generate Repository Languages Report

on:
  schedule:
    # Executa diariamente √†s 8 AM UTC
    - cron: '0 8 * * *'
  workflow_dispatch:
    # Permite execu√ß√£o manual
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/repository-languages.yml'

jobs:
  analyze-languages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyGithub matplotlib pandas
    
    - name: Generate languages report
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_USERNAME: ${{ github.repository_owner }}
      run: |
        python << 'EOF'
        import os
        from github import Github
        import json
        from collections import defaultdict
        from datetime import datetime
        
        # Configura√ß√µes
        token = os.environ.get('GITHUB_TOKEN')
        username = os.environ.get('GITHUB_USERNAME')
        
        if not token or not username:
            print("Erro: GITHUB_TOKEN ou GITHUB_USERNAME n√£o configurados")
            exit(1)
        
        # Conectar ao GitHub
        g = Github(token)
        user = g.get_user(username)
        
        # Coletar dados de todos os reposit√≥rios
        repos_data = []
        total_repos = 0
        
        print(f"Analisando reposit√≥rios de: {username}")
        print("-" * 50)
        
        for repo in user.get_repos():
            total_repos += 1
            print(f"Processando: {repo.name}")
            
            try:
                # Obter linguagens do reposit√≥rio
                languages = repo.get_languages()
                
                repo_info = {
                    "name": repo.name,
                    "full_name": repo.full_name,
                    "url": repo.html_url,
                    "description": repo.description,
                    "created_at": repo.created_at.isoformat(),
                    "updated_at": repo.updated_at.isoformat(),
                    "stars": repo.stargazers_count,
                    "forks": repo.forks_count,
                    "is_fork": repo.fork,
                    "languages": languages,
                    "language": repo.language,
                    "total_bytes": sum(languages.values())
                }
                
                repos_data.append(repo_info)
                
                # Log das linguagens encontradas
                if languages:
                    lang_list = ", ".join(languages.keys())
                    print(f"  Linguagens: {lang_list}")
                else:
                    print(f"  Nenhuma linguagem detectada")
                    
            except Exception as e:
                print(f"  Erro ao processar {repo.name}: {str(e)}")
        
        # An√°lise agregada
        print("\n" + "=" * 50)
        print("AN√ÅLISE COMPLETA DE LINGUAGENS")
        print("=" * 50)
        
        # Contar ocorr√™ncias de cada linguagem
        language_stats = defaultdict(int)
        language_bytes = defaultdict(int)
        repos_per_language = defaultdict(list)
        
        for repo in repos_data:
            for lang, bytes_count in repo["languages"].items():
                language_stats[lang] += 1
                language_bytes[lang] += bytes_count
                repos_per_language[lang].append(repo["name"])
        
        # Ordenar linguagens por frequ√™ncia
        sorted_languages = sorted(
            language_stats.items(), 
            key=lambda x: x[1], 
            reverse=True
        )
        
        # Ordenar por bytes
        sorted_by_bytes = sorted(
            language_bytes.items(),
            key=lambda x: x[1],
            reverse=True
        )
        
        # Gerar relat√≥rio em markdown
        report_content = f"""# üìä Relat√≥rio de Linguagens de Programa√ß√£o

**Usu√°rio:** {username}
**Total de reposit√≥rios analisados:** {total_repos}
**Total de reposit√≥rios com linguagens detectadas:** {len(repos_data)}
**Data da an√°lise:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## üìà Estat√≠sticas Gerais

### Linguagens por N√∫mero de Reposit√≥rios
{chr(10).join([f"1. **{lang}**: {count} reposit√≥rios" for lang, count in sorted_languages[:20]])}

### Linguagens por Volume de C√≥digo
{chr(10).join([f"1. **{lang}**: {bytes_count:,} bytes" for lang, bytes_count in sorted_by_bytes[:15]])}

---

## üìã Detalhes por Linguagem

"""
        
        # Adicionar detalhes de cada linguagem
        for lang, count in sorted_languages:
            percentage = (count / len(repos_data)) * 100 if repos_data else 0
            bytes_total = language_bytes.get(lang, 0)
            
            # Listar reposit√≥rios com esta linguagem
            repos_list = ", ".join([f"`{r}`" for r in repos_per_language[lang][:10]])
            if len(repos_per_language[lang]) > 10:
                repos_list += f" e mais {len(repos_per_language[lang]) - 10}"
            
            report_content += f"""
### {lang}

- **Reposit√≥rios:** {count} ({percentage:.1f}% do total)
- **Total de bytes:** {bytes_total:,}
- **Principais reposit√≥rios:** {repos_list}

"""
        
        # Adicionar tabela detalhada de todos os reposit√≥rios
        report_content += """
---

## üóÇÔ∏è Lista Completa de Reposit√≥rios

| Reposit√≥rio | Linguagem Principal | Outras Linguagens | Estrelas | √öltima Atualiza√ß√£o |
|-------------|-------------------|------------------|----------|-------------------|
"""
        
        for repo in sorted(repos_data, key=lambda x: x["updated_at"], reverse=True):
            repo_name = repo["name"]
            main_lang = repo["language"] or "N/A"
            other_langs = ", ".join(list(repo["languages"].keys())[:3])
            if len(repo["languages"]) > 3:
                other_langs += f"... (+{len(repo['languages']) - 3})"
            stars = repo["stars"]
            updated = datetime.fromisoformat(repo["updated_at"][:-1]).strftime('%Y-%m-%d')
            
            report_content += f"| [{repo_name}]({repo['url']}) | {main_lang} | {other_langs} | ‚≠ê {stars} | {updated} |\n"
        
        # Salvar relat√≥rio
        report_filename = "LANGUAGES_REPORT.md"
        with open(report_filename, "w", encoding="utf-8") as f:
            f.write(report_content)
        
        # Salvar dados brutos em JSON
        json_filename = "languages_data.json"
        with open(json_filename, "w", encoding="utf-8") as f:
            json.dump({
                "metadata": {
                    "username": username,
                    "total_repos": total_repos,
                    "analyzed_repos": len(repos_data),
                    "generated_at": datetime.now().isoformat()
                },
                "language_stats": dict(language_stats),
                "language_bytes": dict(language_bytes),
                "repos_per_language": dict(repos_per_language),
                "repositories": repos_data
            }, f, indent=2, ensure_ascii=False)
        
        print(f"\nRelat√≥rio salvo em: {report_filename}")
        print(f"Dados completos em: {json_filename}")
        print(f"Total de linguagens √∫nicas encontradas: {len(language_stats)}")
        
        EOF
    
    - name: Commit and push report
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add LANGUAGES_REPORT.md languages_data.json
        git commit -m "üìä Update languages report [skip ci]" || echo "No changes to commit"
        git push
