name: üìä Generate Repository Languages Report

on:
  schedule:
    - cron: '0 8 * * *' # Executa diariamente √†s 8h UTC
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/languages.yml'

permissions:
  contents: write

jobs:
  analyze-languages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install PyGithub pandas

      - name: Generate languages report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          python << 'EOF'
          import os
          import json
          from github import Github
          from collections import defaultdict
          from datetime import datetime

          token = os.environ.get('GITHUB_TOKEN')
          username = os.environ.get('GITHUB_USERNAME')

          if not token or not username:
              raise Exception("GITHUB_TOKEN ou GITHUB_USERNAME n√£o configurados")

          g = Github(token)
          user = g.get_user(username)

          repos_data = []
          total_repos = 0

          print(f"Analisando reposit√≥rios de: {username}")

          for repo in user.get_repos():
              total_repos += 1
              try:
                  languages = repo.get_languages()
                  repo_info = {
                      "name": repo.name,
                      "full_name": repo.full_name,
                      "url": repo.html_url,
                      "description": repo.description or "",
                      "created_at": repo.created_at.isoformat(),
                      "updated_at": repo.updated_at.isoformat(),
                      "stars": repo.stargazers_count,
                      "forks": repo.forks_count,
                      "is_fork": repo.fork,
                      "languages": languages,
                      "language": repo.language,
                      "total_bytes": sum(languages.values())
                  }
                  repos_data.append(repo_info)
              except Exception as e:
                  print(f"Erro ao processar {repo.name}: {e}")

          # Estat√≠sticas
          language_stats = defaultdict(int)
          language_bytes = defaultdict(int)
          repos_per_language = defaultdict(list)

          for repo in repos_data:
              for lang, bytes_count in repo["languages"].items():
                  language_stats[lang] += 1
                  language_bytes[lang] += bytes_count
                  repos_per_language[lang].append(repo["name"])

          sorted_languages = sorted(language_stats.items(), key=lambda x: x[1], reverse=True)
          sorted_by_bytes = sorted(language_bytes.items(), key=lambda x: x[1], reverse=True)

          # Relat√≥rio Markdown
          report_md = f"# üìä Relat√≥rio de Linguagens de Programa√ß√£o\n\n"
          report_md += f"**Usu√°rio:** {username}\n"
          report_md += f"**Total de reposit√≥rios analisados:** {total_repos}\n"
          report_md += f"**Reposit√≥rios com linguagens detectadas:** {len(repos_data)}\n"
          report_md += f"**Data da an√°lise:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
          report_md += "---\n\n## üìà Estat√≠sticas Gerais\n\n"
          report_md += "### Linguagens por N√∫mero de Reposit√≥rios\n"
          report_md += "\n".join([f"1. **{lang}**: {count} reposit√≥rios" for lang, count in sorted_languages[:20]]) + "\n\n"
          report_md += "### Linguagens por Volume de C√≥digo\n"
          report_md += "\n".join([f"1. **{lang}**: {bytes_count:,} bytes" for lang, bytes_count in sorted_by_bytes[:15]]) + "\n\n"
          report_md += "---\n\n## üóÇÔ∏è Lista Completa de Reposit√≥rios\n\n"
          report_md += "| Reposit√≥rio | Linguagem Principal | Outras Linguagens | Estrelas | √öltima Atualiza√ß√£o |\n"
          report_md += "|-------------|-------------------|-----------------|----------|------------------|\n"

          for repo in sorted(repos_data, key=lambda x: x["updated_at"], reverse=True):
              main_lang = repo["language"] or "N/A"
              other_langs = ", ".join(list(repo["languages"].keys())[:3])
              if len(repo["languages"]) > 3:
                  other_langs += f"... (+{len(repo['languages'])-3})"
              updated = datetime.fromisoformat(repo["updated_at"][:-1]).strftime('%Y-%m-%d')
              report_md += f"| [{repo['name']}]({repo['url']}) | {main_lang} | {other_langs} | ‚≠ê {repo['stars']} | {updated} |\n"

          # Salvar Markdown
          with open("LANGUAGES_REPORT.md", "w", encoding="utf-8") as f:
              f.write(report_md)

          # Salvar JSON
          with open("languages_data.json", "w", encoding="utf-8") as f:
              json.dump({
                  "metadata": {"username": username, "total_repos": total_repos, "analyzed_repos": len(repos_data), "generated_at": datetime.now().isoformat()},
                  "language_stats": dict(language_stats),
                  "language_bytes": dict(language_bytes),
                  "repos_per_language": dict(repos_per_language),
                  "repositories": repos_data
              }, f, indent=2, ensure_ascii=False)

          print("Relat√≥rio Markdown e JSON gerados com sucesso!")
          EOF

      - name: Commit and push report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add LANGUAGES_REPORT.md languages_data.json
          git diff --cached --quiet || git commit -m "üìä Update languages report [skip ci]"
          git push
